# End-to-End Integration Tests

Comprehensive E2E tests for RiffRoom using Playwright.

## Test Coverage

### integration.spec.ts
Full workflow testing:
- ✓ File upload (drag & drop simulation)
- ✓ Backend processing with WebSocket progress
- ✓ Stem separation completion
- ✓ Audio playback functionality
- ✓ Keyboard shortcuts
- ✓ Error handling (invalid files, file size limits)
- ✓ Error boundaries (no crashes on unexpected errors)

### app.spec.ts
Basic UI testing:
- ✓ App loads correctly
- ✓ Main UI elements visible
- ✓ Keyboard shortcuts overlay
- ✓ Drag-drop zone instructions

## Prerequisites

### 1. Backend Server
The integration tests require the backend to be running:

```bash
cd packages/backend
./start-backend.sh
```

Wait for health check to pass before running E2E tests.

### 2. Test Fixtures
Test audio files are auto-generated before each E2E test run.

Manual generation:
```bash
npm run setup:test-fixtures
```

This creates:
- `tests/fixtures/test-audio.mp3` (~48KB, 3 seconds)
- Contains all 4 "stem" components (drums, bass, other, vocals)
- Processes quickly (10-15s) for fast test execution

## Running Tests

### All tests (auto-generates fixtures)
```bash
npm run test:e2e
```

### Interactive UI mode
```bash
npm run test:e2e:ui
```

### Headed mode (see browser)
```bash
npm run test:e2e:headed
```

### Specific test file
```bash
npx playwright test integration.spec.ts
```

### Specific test
```bash
npx playwright test -g "should complete full workflow"
```

## Test Configuration

**playwright.config.ts:**
- Base URL: `http://localhost:5173`
- Auto-starts web server (`pnpm dev`)
- Browsers: Chromium, Firefox, WebKit
- Retries: 2 (CI only)
- Screenshots: On failure only
- Traces: On first retry

## Debugging

### View test report
```bash
npx playwright show-report
```

### Debug specific test
```bash
npx playwright test --debug integration.spec.ts
```

### Generate screenshots
Screenshots are automatically saved to `test-results/` on failure.

### View traces
```bash
npx playwright show-trace test-results/.../trace.zip
```

## CI/CD Integration

The E2E tests are designed for CI/CD pipelines:

```yaml
# .github/workflows/test.yml example
- name: Setup backend
  run: |
    cd packages/backend
    uv sync
    uv run uvicorn app.main:app &
    sleep 5  # Wait for backend to start

- name: Run E2E tests
  run: |
    cd packages/web
    npm run test:e2e
```

## Test Data

### Test Audio File
Generated by `tests/fixtures/generate-test-audio.py`:
- **Duration**: 3 seconds
- **Sample rate**: 44.1kHz
- **Format**: MP3 (48KB)
- **Content**: Synthetic mix of drums, bass, guitar, vocals
- **Processing time**: ~10-15 seconds (varies by CPU/GPU)

## Troubleshooting

### Backend not running
```
Error: Backend not running. Start with: cd packages/backend && ./start-backend.sh
```

**Solution**: Start backend server before running E2E tests.

### Test audio not found
```
Error: Test audio file not found. Run: npm run setup:test-fixtures
```

**Solution**: Fixtures are auto-generated, but you can manually run:
```bash
npm run setup:test-fixtures
```

### Tests timeout
If tests timeout waiting for processing:
- Check backend logs for errors
- Verify backend health: `curl http://localhost:8007/health`
- Check WebSocket connection in browser console
- Increase timeout in test (default: 90s for processing)

### Browser doesn't close
```bash
# Kill Playwright browsers
pkill -f playwright
```

## Writing New Tests

### Test structure
```typescript
test('should do something', async ({ page }) => {
  await page.goto('/');

  // Interact with UI
  await page.click('button');

  // Assert
  await expect(page.getByText('Success')).toBeVisible();
});
```

### Best practices
- ✓ Use semantic selectors (roles, labels, text)
- ✓ Wait for elements with `toBeVisible()` instead of `waitForTimeout()`
- ✓ Test real user workflows, not implementation details
- ✓ Clean up state between tests
- ✓ Use descriptive test names
- ✗ Don't test internal state or component props
- ✗ Don't rely on brittle CSS selectors

## Performance

Typical E2E test times:
- **Full integration test**: 30-45s (including 10-15s processing)
- **UI tests**: 5-10s each
- **Total suite**: 2-3 minutes (all browsers, parallel)

## Next Steps

Potential test additions:
- [ ] Loop functionality (set start/end markers)
- [ ] Waveform visualization
- [ ] Practice streak tracking
- [ ] Multiple file processing
- [ ] Offline mode (IndexedDB cache)
- [ ] Desktop app (Electron) tests
